name: Common Unit Tests

on:
  workflow_call:
    inputs:
      platform:
        required: true
        type: string
        description: Platform name (e.g., cuda, default)
      device:
        required: true
        type: string
        description: Device type (e.g., a100, a800, h100, generic)
      image:
        required: true
        type: string
      runs_on:
        required: true
        type: string
      container_volumes:
        required: true
        type: string
      container_options:
        required: true
        type: string
      ignored_tests:
        required: false
        type: string
        default: ''
        description: JSON array of test files to ignore (e.g., '["tests/unit_tests/test_a.py", "tests/unit_tests/test_b.py"]')

jobs:
  unit_test:
    defaults:
      run:
        shell: bash
    env:
      PROJECT_ROOT: /workspace/Megatron-LM-FL
    runs-on: ${{ fromJson(inputs.runs_on) }}
    name: unit-${{ inputs.device }}
    container:
      image: ${{ inputs.image }}
      ports:
        - 80
      volumes: ${{ fromJson(inputs.container_volumes) }}
      options: ${{ inputs.container_options }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@v6
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          ssh-strict: true
          ssh-user: git
          ssh-key: ${{ secrets.RUNNER_SSH_KEY }}
          persist-credentials: false
          clean: true
          sparse-checkout-cone-mode: true
          fetch-tags: false
          show-progress: true
          lfs: false

      - name: Set safe directory
        run: |
          git config --global --add safe.directory $PROJECT_ROOT

      - name: Setup Python environment
        run: |
          set -euo pipefail
          cd $PROJECT_ROOT
    
          echo "Python location: $(which python)"
          echo "Python version: $(python --version)"
          pip install pytest-mock nltk
          # Install package in development mode
          pip install -e . --no-deps || true

          # Copy test data
          mkdir -p /opt/data
          wget -O /opt/data/datasets.zip https://baai-flagscale.ks3-cn-beijing.ksyuncs.com/temp/datasets.zip && unzip -o /opt/data/datasets.zip -d /opt/data && rm /opt/data/datasets.zip
          wget -O /opt/data/tokenizers.zip https://baai-flagscale.ks3-cn-beijing.ksyuncs.com/temp/tokenizers.zip && unzip -o /opt/data/tokenizers.zip -d /opt/data && rm /opt/data/tokenizers.zip
        timeout-minutes: 30

      - name: Run unit tests
        id: unit_test
        run: |
          set -euo pipefail
          cd $PROJECT_ROOT

          PLATFORM='${{ inputs.platform }}'
          DEVICE='${{ inputs.device }}'

          echo "Running unit tests"
          echo "Platform: $PLATFORM"
          echo "Device: $DEVICE"
          echo "Project root: $PROJECT_ROOT"

          # Display Python environment info
          echo "Python location: $(which python)"
          echo "Python version: $(python --version)"

          # Set environment variables
          export PYTHONPATH=$PROJECT_ROOT:${PYTHONPATH:-}
          export TORCHINDUCTOR_CACHE_DIR=/workspace/.torch_inductor_cache
          mkdir -p $TORCHINDUCTOR_CACHE_DIR

          # Build ignore options from ignored_tests input
          IGNORED_TESTS='${{ inputs.ignored_tests }}'
          IGNORE_OPTS=""
          if [ -n "$IGNORED_TESTS" ] && [ "$IGNORED_TESTS" != "[]" ]; then
            echo "Parsing ignored tests list..."
            # Parse JSON array and build --ignore options
            IGNORE_OPTS=$(echo "$IGNORED_TESTS" | python3 -c "import sys, json; tests = json.load(sys.stdin); print(' '.join(['--ignore=' + t for t in tests])) if tests else None")
            if [ -n "$IGNORE_OPTS" ]; then
              echo "Ignoring tests: $IGNORE_OPTS"
            fi
          fi

          # Run unit tests with torchrun
          torchrun --nproc_per_node=8 -m pytest -v tests/unit_tests $IGNORE_OPTS
          exit_code=$?

          if [ $exit_code -eq 0 ]; then
            echo "✅ Unit tests passed for $PLATFORM/$DEVICE"
          else
            echo "❌ Unit tests failed for $PLATFORM/$DEVICE (exit code: $exit_code)"
          fi

          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code
        timeout-minutes: 60
